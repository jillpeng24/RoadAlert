<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>產業道路警示系統</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; transition: background 0.5s; text-align: center; overflow: hidden; }
        .green { background-color: #28a745; color: white; }
        .red { background-color: #dc3545; color: white; }
        
        h1 { font-size: 3rem; margin: 0; padding: 0 10px; font-weight: bold; }
        .info { font-size: 1.6rem; margin: 15px 20px; line-height: 1.4; }
        .publish-time { font-size: 1.2rem; opacity: 0.8; margin-bottom: 5px; }
        .timer { font-size: 7rem; font-weight: bold; margin: 10px 0; font-variant-numeric: tabular-nums; }
        
        .button-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        button { width: 85%; max-width: 350px; padding: 25px; margin: 15px; font-size: 2rem; border: none; border-radius: 60px; cursor: pointer; box-shadow: 0 8px 25px rgba(0,0,0,0.3); font-weight: bold; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.95); }
        
        .btn-main { background: white; color: #28a745; }
        .btn-reset { background: white; color: #dc3545; font-size: 1.6rem; margin-top: 20px; }
    </style>
</head>
<body class="green" id="bg">

    <div id="display-area">
        <h1 id="status-text">✅ 道路暢通</h1>
        <div id="info-text" class="info">請選擇行進方向</div>
        <div id="publish-time" class="publish-time"></div>
        <div id="timer" class="timer" style="display:none;">05:00</div>
    </div>

    <div id="start-buttons" class="button-container">
        <button class="btn-main" onclick="startAlert('up')">⬆ 我要上山</button>
        <button class="btn-main" onclick="startAlert('down')">⬇ 我要下山</button>
    </div>

    <div id="reset-area" class="button-container" style="display:none;">
        <button class="btn-reset" onclick="clearAlert()">❌ 已通過 (解除警示)</button>
    </div>

    <script>
        // --- 填入您的 Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDAgZJZ7HBbUF4_BfXC2sWr4shkJ4AX0h4",
            authDomain: "road-alert-bd5e1.firebaseapp.com",
            databaseURL: "https://road-alert-bd5e1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-alert-bd5e1",
            storageBucket: "road-alert-bd5e1.firebasestorage.app",
            messagingSenderId: "250765942975",
            appId: "1:250765942975:web:2b6ab9e46074cc5ba4e60a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('road_system');

        function startAlert(dir) {
            const now = Date.now();
            const expire = now + (5 * 60 * 1000); 
            const timeStr = new Date(now).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            const msg = (dir === 'up') ? "有車上山中，請勿出發" : "有車下山中，請勿進入";
            
            db.set({ 
                status: 'busy', 
                direction: dir, 
                expire_time: expire, 
                publish_time: timeStr,
                message: msg 
            });
        }

        function clearAlert() {
            db.set({ status: 'clear' });
        }

        db.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            if (data.status === 'busy' && data.expire_time > now) {
                document.getElementById('bg').className = 'red';
                document.getElementById('status-text').innerText = (data.direction === 'up' ? "⬆ 上山警示中" : "⬇ 下山警示中");
                document.getElementById('info-text').innerText = data.message;
                document.getElementById('publish-time').innerText = "發布時間：" + data.publish_time;
                document.getElementById('timer').style.display = 'block';
                document.getElementById('start-buttons').style.display = 'none';
                document.getElementById('reset-area').style.display = 'flex';
                
                // 僅播報基本警示音/方向語音，移除雨天字眼
                if (window.lastExpire !== data.expire_time) {
                    const speech = new SpeechSynthesisUtterance(data.message);
                    speech.lang = 'zh-TW';
                    window.speechSynthesis.speak(speech);
                    window.lastExpire = data.expire_time;
                }
                updateTimer(data.expire_time);
            } else {
                document.getElementById('bg').className = 'green';
                document.getElementById('status-text').innerText = "✅ 道路暢通";
                document.getElementById('info-text').innerText = "請選擇行進方向";
                document.getElementById('publish-time').innerText = "";
                document.getElementById('timer').style.display = 'none';
                document.getElementById('start-buttons').style.display = 'flex';
                document.getElementById('reset-area').style.display = 'none';
                if (window.timerInterval) clearInterval(window.timerInterval);
            }
        });

        function updateTimer(expire) {
            if (window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                const remaining = Math.round((expire - Date.now()) / 1000);
                if (remaining <= 0) {
                    clearInterval(window.timerInterval);
                    db.update({ status: 'clear' });
                } else {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
