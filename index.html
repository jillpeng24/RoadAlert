<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦šé“è·¯è­¦ç¤ºç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; transition: background 0.5s ease; text-align: center; overflow: hidden; color: white; }
        .green { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
        .red { background: linear-gradient(135deg, #f85032 0%, #e73827 100%); }
        
        /* æ¨™é¡Œèˆ‡è¨ˆæ™‚å™¨å¤§å°èª¿æ•´ */
        h1 { font-size: 3.5rem; margin: 0; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .info { font-size: 1.3rem; margin: 15px 20px; opacity: 0.9; }
        .publish-time { font-size: 1rem; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 15px; display: inline-block; margin-bottom: 10px; }
        .timer { font-size: 4rem; font-weight: 800; margin: 5px 0; font-variant-numeric: tabular-nums; }
        
        .button-container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* ä¸¦æ’æŒ‰éˆ•æ¨£å¼ */
        .button-row { width: 90%; max-width: 400px; display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        
        button { border: none; border-radius: 40px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 600; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
        
        .btn-main { width: 70%; max-width: 280px; padding: 18px; margin: 10px; font-size: 1.5rem; background: white; color: #56ab2f; }
        
        /* è­¦ç¤ºä¸­æŒ‰éˆ•ï¼šä¸¦æ’ä¸”ç¸®å°å­—é«”ä»¥å®¹ç´æ–‡å­— */
        .btn-half { flex: 1; padding: 15px 5px; font-size: 1.2rem; background: white; }
        .btn-extend { color: black; } /* å»¶é•·è­¦ç¤ºï¼šé»‘è‰²å­— */
        .btn-clear { color: #56ab2f; } /* è§£é™¤ï¼šç¶ è‰²å­— */

        .car-icon { font-size: 2.5rem; }
    </style>
</head>
<body class="green" id="bg">

    <div id="display-area">
        <h1 id="status-text"><span class="car-icon">ğŸš™</span>&nbsp;&nbsp;é“è·¯æš¢é€š&nbsp;&nbsp;<span class="car-icon">ğŸš™</span></h1>
        <div id="info-text" class="info">è«‹é¸æ“‡è¡Œé€²æ–¹å‘</div>
        <div id="publish-time" class="publish-time"></div>
        <div id="timer" class="timer" style="display:none;">05:00</div>
    </div>

    <div id="start-buttons" class="button-container">
        <button class="btn-main" onclick="startAlert('up')">&#11014; æˆ‘è¦ä¸Šå±±</button>
        <button class="btn-main" onclick="startAlert('down')">&#11015; æˆ‘è¦ä¸‹å±±</button>
    </div>

    <div id="reset-area" class="button-container" style="display:none;">
        <div class="button-row">
            <button class="btn-half btn-extend" onclick="extendAlert()">ğŸ•’ å»¶é•·è­¦ç¤º</button>
            <button class="btn-half btn-clear" onclick="clearAlert()">â­• å·²é€šé (è§£é™¤)</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDAgZJZ7HBbUF4_BfXC2sWr4shkJ4AX0h4",
            authDomain: "road-alert-bd5e1.firebaseapp.com",
            databaseURL: "https://road-alert-bd5e1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-alert-bd5e1",
            storageBucket: "road-alert-bd5e1.firebasestorage.app",
            messagingSenderId: "250765942975",
            appId: "1:250765942975:web:2b6ab9e46074cc5ba4e60a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('road_system');

        function startAlert(dir) {
            const now = Date.now();
            const expire = now + (5 * 60 * 1000); 
            // ä¿®æ­£ï¼š24å°æ™‚åˆ¶ æ—¥æœŸ/æ™‚é–“
            const d = new Date(now);
            const timeStr = `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            const msg = (dir === 'up') ? "æœ‰è»Šä¸Šå±±ä¸­ï¼Œè«‹å‹¿å‡ºç™¼" : "æœ‰è»Šä¸‹å±±ä¸­ï¼Œè«‹å‹¿é€²å…¥";
            
            db.set({ status: 'busy', direction: dir, expire_time: expire, publish_time: timeStr, message: msg });
        }

        // æ–°å¢ï¼šå»¶é•·è­¦ç¤ºåŠŸèƒ½
        function extendAlert() {
            const now = Date.now();
            const expire = now + (5 * 60 * 1000);
            db.update({ expire_time: expire });
            const speech = new SpeechSynthesisUtterance("é“è·¯ä¸ŠæŒçºŒæœ‰è»Šè¼›è¡Œé§›ï¼Œè«‹ç¨å¾Œ");
            speech.lang = 'zh-TW';
            window.speechSynthesis.speak(speech);
        }

        function clearAlert() {
            db.set({ status: 'clear' });
        }

        db.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            if (data.status === 'busy' && data.expire_time > now) {
                document.getElementById('bg').className = 'red';
                document.getElementById('status-text').innerHTML = "âš ï¸&nbsp;&nbsp;è»Šé“è­¦ç¤º&nbsp;&nbsp;âš ï¸";
                document.getElementById('info-text').innerText = data.message;
                document.getElementById('publish-time').innerText = "ç™¼å¸ƒæ™‚é–“ï¼š" + data.publish_time;
                document.getElementById('timer').style.display = 'block';
                document.getElementById('start-buttons').style.display = 'none';
                document.getElementById('reset-area').style.display = 'flex';
                
                if (window.lastExpire !== data.expire_time) {
                    const speech = new SpeechSynthesisUtterance(data.message);
                    speech.lang = 'zh-TW';
                    window.speechSynthesis.speak(speech);
                    window.lastExpire = data.expire_time;
                }
                updateTimer(data.expire_time);
            } else {
                document.getElementById('bg').className = 'green';
                document.getElementById('status-text').innerHTML = '<span class="car-icon">ğŸš™</span>&nbsp;&nbsp;é“è·¯æš¢é€š&nbsp;&nbsp;<span class="car-icon">ğŸš™</span>';
                document.getElementById('info-text').innerText = "è«‹é¸æ“‡è¡Œé€²æ–¹å‘";
                document.getElementById('publish-time').innerText = "";
                document.getElementById('timer').style.display = 'none';
                document.getElementById('start-buttons').style.display = 'flex';
                document.getElementById('reset-area').style.display = 'none';
                if (window.timerInterval) clearInterval(window.timerInterval);
            }
        });

        function updateTimer(expire) {
            if (window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                const remaining = Math.round((expire - Date.now()) / 1000);
                if (remaining <= 0) {
                    clearInterval(window.timerInterval);
                    db.update({ status: 'clear' });
                } else {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
