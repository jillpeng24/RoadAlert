<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”¢æ¥­é“è·¯è­¦ç¤ºç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        /* åŸºç¤æ¨£å¼èˆ‡æ¼¸å±¤èƒŒæ™¯ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; transition: background 0.8s ease; text-align: center; overflow: hidden; color: white; }
        
        .green { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
        .red { background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%); }
        
        /* å…§å®¹å€å¡Š */
        h1 { font-size: 2.8rem; margin: 0; padding: 0 10px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .info { font-size: 1.6rem; margin: 20px 20px; line-height: 1.4; opacity: 0.95; }
        .publish-time { font-size: 1.2rem; opacity: 0.8; margin-bottom: 5px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 20px; display: inline-block; }
        .timer { font-size: 8rem; font-weight: 900; margin: 5px 0; font-variant-numeric: tabular-nums; letter-spacing: -3px; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        
        /* æŒ‰éˆ•æ¨£å¼ç¾åŒ– */
        .button-container { width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 10; }
        button { width: 85%; max-width: 380px; padding: 25px; margin: 15px; font-size: 2.2rem; border: none; border-radius: 25px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-weight: bold; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
        
        /* ç¶ ç‡ˆæ™‚çš„æŒ‰éˆ• (ç™½è‰²åŸºåº•) */
        .btn-main { background: white; color: #1e7e34; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* è§£é™¤è­¦ç¤ºæŒ‰éˆ• (äº®ç™½è‰²) */
        .btn-reset { background: white; color: #dc3545; font-size: 1.8rem; margin-top: 30px; border-radius: 20px; animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .car-icon { font-size: 3rem; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
    </style>
</head>
<body class="green" id="bg">

    <div id="display-area">
        <h1 id="status-text"><span class="car-icon">ğŸš™</span> é“è·¯æš¢é€š <span class="car-icon">ğŸš™</span></h1>
        <div id="info-text" class="info">è«‹é¸æ“‡è¡Œé€²æ–¹å‘</div>
        <div id="publish-time" class="publish-time"></div>
        <div id="timer" class="timer" style="display:none;">05:00</div>
    </div>

    <div id="start-buttons" class="button-container">
        <button class="btn-main" onclick="startAlert('up')">â¬† æˆ‘è¦ä¸Šå±±</button>
        <button class="btn-main" onclick="startAlert('down')">â¬‡ æˆ‘è¦ä¸‹å±±</button>
    </div>

    <div id="reset-area" class="button-container" style="display:none;">
        <button class="btn-reset" onclick="clearAlert()">âŒ å·²é€šé (è§£é™¤è­¦ç¤º)</button>
    </div>

    <script>
        // --- è«‹ç¢ºèªæ­¤è™•å¡«å…¥æ‚¨çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDAgZJZ7HBbUF4_BfXC2sWr4shkJ4AX0h4",
            authDomain: "road-alert-bd5e1.firebaseapp.com",
            databaseURL: "https://road-alert-bd5e1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "road-alert-bd5e1",
            storageBucket: "road-alert-bd5e1.firebasestorage.app",
            messagingSenderId: "250765942975",
            appId: "1:250765942975:web:2b6ab9e46074cc5ba4e60a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('road_system');

        function startAlert(dir) {
            const now = Date.now();
            const expire = now + (5 * 60 * 1000); 
            const timeStr = new Date(now).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            const msg = (dir === 'up') ? "æœ‰è»Šä¸Šå±±ä¸­ï¼Œè«‹å‹¿å‡ºç™¼" : "æœ‰å‡ºä¸‹å±±ä¸­ï¼Œè«‹å‹¿é€²å…¥";
            
            db.set({ 
                status: 'busy', 
                direction: dir, 
                expire_time: expire, 
                publish_time: timeStr,
                message: msg 
            });
        }

        function clearAlert() {
            db.set({ status: 'clear' });
        }

        db.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const now = Date.now();
            if (data.status === 'busy' && data.expire_time > now) {
                document.getElementById('bg').className = 'red';
                document.getElementById('status-text').innerHTML = (data.direction === 'up' ? "â¬† ä¸Šå±±è­¦ç¤ºä¸­" : "â¬‡ ä¸‹å±±è­¦ç¤ºä¸­");
                document.getElementById('info-text').innerText = data.message;
                document.getElementById('publish-time').innerText = "ç™¼å¸ƒæ™‚é–“ï¼š" + data.publish_time;
                document.getElementById('timer').style.display = 'block';
                document.getElementById('start-buttons').style.display = 'none';
                document.getElementById('reset-area').style.display = 'flex';
                
                if (window.lastExpire !== data.expire_time) {
                    const speech = new SpeechSynthesisUtterance(data.message);
                    speech.lang = 'zh-TW';
                    window.speechSynthesis.speak(speech);
                    window.lastExpire = data.expire_time;
                }
                updateTimer(data.expire_time);
            } else {
                document.getElementById('bg').className = 'green';
                document.getElementById('status-text').innerHTML = '<span class="car-icon">ğŸš™</span> é“è·¯æš¢é€š <span class="car-icon">ğŸš™</span>';
                document.getElementById('info-text').innerText = "è«‹é¸æ“‡è¡Œé€²æ–¹å‘";
                document.getElementById('publish-time').innerText = "";
                document.getElementById('timer').style.display = 'none';
                document.getElementById('start-buttons').style.display = 'flex';
                document.getElementById('reset-area').style.display = 'none';
                if (window.timerInterval) clearInterval(window.timerInterval);
            }
        });

        function updateTimer(expire) {
            if (window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                const remaining = Math.round((expire - Date.now()) / 1000);
                if (remaining <= 0) {
                    clearInterval(window.timerInterval);
                    db.update({ status: 'clear' });
                } else {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
